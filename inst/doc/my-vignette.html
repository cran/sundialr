<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Satyaprakash Nayak" />

<meta name="date" content="2019-06-09" />

<title>sundialr - An Interface to ‘SUNDIALS’ Ordinary Differential Equation (ODE) Solvers</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">sundialr - An Interface to ‘SUNDIALS’ Ordinary Differential Equation (ODE) Solvers</h1>
<h4 class="author">Satyaprakash Nayak</h4>
<h4 class="date">2019-06-09</h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Ordinary Differential Equations (ODEs) describe the rate of change of dependent variables with respect to a single independent variable and are used in many fields to model behavior of the system. There are many good <code>C</code> libraries available to solve (i.e., integrate systems of ODEs) and <a href="https://computation.llnl.gov/projects/sundials/sundials-software">SUNDIALS</a> available from the Lawrence Livermore National Laboratory is a one of the most popular and well-respected <code>C</code> library for solving non-stiff and stiff systems of ODEs.</p>
<p>Currently, this package provides an interface to the <code>CVODE</code> and <code>CVODES</code> function (serial version) in the library which is used to solve ODEs (or Initial Value Problems) and calculate sensitivities.</p>
<p>The two exported functions from the package are:</p>
<ul>
<li><code>CVODE</code> - An interface to the <code>CVODE</code> function in <code>SUNDIALS</code> to solve a system of ODEs.</li>
<li><code>CVODES</code> - An interface to the <code>CVODES</code> function in <code>SUNDIALS</code> to calculate forward sensitivites with respect to parameters of the ODE system.</li>
</ul>
<p>In future, we plan to provide interface for the other solvers (i.e., <code>IDA/IDAS</code> and <code>ARCODE</code> in the library also. Right now, this package serves as a test case for providing an interface to the <code>SUNDIALS</code> library for <code>R</code> users.</p>
<p><em>One of the advantage of using this package is that all the source code of the <code>SUNDIALS</code> library is bundled with the package itself, so it does not require the <code>SUNDIALS</code> library to be installed on the machine separately (which is sometimes non trivial on a Windows machine).</em></p>
</div>
<div id="system-of-odes" class="section level2">
<h2>System of ODEs</h2>
<p>As described in the link above, the problem is from chemical kinetics, and consists of the following three rate equations:</p>
<p><span class="math display">\[ 
\begin{aligned}
\frac{dy_1}{dt} &amp;= -.04 \times y_1 + 10^4 \times y_2 \times y_3  \\ 
\frac{dy_2}{dt} &amp;= .04 \times y_1 - 10^4 \times y_2 \times y_3 - 3 \times 10^7  \times y_2^2 \\
\frac{dy_3}{dt} &amp;= 3 \times 10^7 \times y_2^2 
\end{aligned}
\]</span></p>
<p>with time interval from <span class="math inline">\(t = 0.0\)</span> to <span class="math inline">\(t = 4 \times 10^{10}\)</span> and initial conditions: <span class="math display">\[ y_1  = 1.0 , ~y_2 = y_3 = 0 \]</span></p>
<p><strong>The problem is stiff.</strong></p>
<p>The original example , While integrating the system, also uses the rootfinding feature to find the points at which</p>
<p><span class="math display">\[ y_1 = 1 \times 10^{-4} \]</span> or at which <span class="math display">\[ y_3 = 0.01 \]</span> but currently root-finding is not supported in this version. As in the original example, this package also solves the problem with the <code>BDF</code> method, Newton iteration with the <code>SUNDENSE</code> dense linear solver, however, without a user-supplied Jacobian routine (unlike the original example). The future versions may include an ability to provide Jacobian calculated analytically or via automatic differentiation. <code>CVODE</code> uses a scalar relative tolerance and a vector absolute tolerance (which can be provided as an input). Output is printed in decades from <span class="math inline">\(t = 0.4\)</span> to <span class="math inline">\(t = 4 \times 10^{10}\)</span> in this example.</p>
</div>
<div id="writing-the-differential-equations" class="section level2">
<h2>Writing the Differential Equations</h2>
<div id="using-r" class="section level3">
<h3>Using R</h3>
<p>Differential equations can be written as an <code>R</code> function or as an <code>Rcpp</code> function. Differential equations function must be written as</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="cf">function</span>(t, y, p){</a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="co"># code to write differential equations</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="co"># using parameter vector (p) and state/entity vector (y)</span></a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="co"># should return `ydot`, the vector representing</span></a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="co"># rate of change of entities in `y`</span></a>
<a class="sourceLine" id="cb1-6" title="6">  <span class="co"># length of `ydot` must be equal to `y1</span></a>
<a class="sourceLine" id="cb1-7" title="7">}</a></code></pre></div>
<p>where <code>t</code> represents time, <code>y</code> is the vector describing the values of states/entities of the ODE system at time <code>t</code> and <code>p</code> is the vector of parameters used to define the ODEs. The output of this function is a vector of rate of change of entities of <code>y</code>.</p>
<p>The key aspect to keep in mind is that the signature of the function must be <code>function(t,y,p)</code>. As an example, we try to solve the <code>cv_Roberts_dns.c</code> problem described above, the original code can be found <a href="https://github.com/LLNL/sundials/blob/master/examples/cvode/serial/cvRoberts_dns.c">here</a>. An example of an <code>R</code> function is as follows:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">ODE_R &lt;-<span class="st"> </span><span class="cf">function</span>(t, y, p){</a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3">   <span class="co">## initialize the derivative vector</span></a>
<a class="sourceLine" id="cb2-4" title="4">   ydot &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="dt">length =</span> <span class="kw">length</span>(y))</a>
<a class="sourceLine" id="cb2-5" title="5">   </a>
<a class="sourceLine" id="cb2-6" title="6">   <span class="co">## p (parameter vector input) is  [-0.04 1e04 3e07]</span></a>
<a class="sourceLine" id="cb2-7" title="7">   </a>
<a class="sourceLine" id="cb2-8" title="8">   ydot[<span class="dv">1</span>] =<span class="st"> </span>p[<span class="dv">1</span>]<span class="op">*</span>y[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>p[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb2-9" title="9">   ydot[<span class="dv">2</span>] =<span class="st"> </span><span class="op">-</span>p[<span class="dv">1</span>]<span class="op">*</span>y[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>p[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">3</span>] <span class="op">-</span><span class="st"> </span>p[<span class="dv">3</span>]<span class="op">*</span>y[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb2-10" title="10">   ydot[<span class="dv">3</span>] =<span class="st"> </span>p[<span class="dv">3</span>]<span class="op">*</span>y[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb2-11" title="11"></a>
<a class="sourceLine" id="cb2-12" title="12">   ydot      <span class="co">## return ydot</span></a>
<a class="sourceLine" id="cb2-13" title="13">}</a></code></pre></div>
<p>where <code>p</code> is a parameter vector with the values <code>[-0.04 1e04 3e07]</code>.</p>
</div>
<div id="using-rcpp" class="section level3">
<h3>Using Rcpp</h3>
<p>Also, since this package using <code>Rcpp</code> to bundle the C code, we can use the notation used in <code>Rcpp</code> to describe the system of ODEs. The <code>cv_Roberts_dns</code> problem describe above can be described in an <code>Rcpp</code> function as follows (indices in <code>C++</code> start from <code>0</code>, functions need to declare their return type, here <code>NumericVector</code> and every expression ends in a semicolon, <code>;</code>) :</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb3-1" title="1"><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">using</span> <span class="kw">namespace</span> Rcpp;</a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">// [[Rcpp::export]]</span></a>
<a class="sourceLine" id="cb3-5" title="5">NumericVector ODE_Rcpp (<span class="dt">double</span> t, NumericVector y){</a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7">  <span class="co">// Initialize ydot filled with zeros</span></a>
<a class="sourceLine" id="cb3-8" title="8">  NumericVector ydot(y.length());</a>
<a class="sourceLine" id="cb3-9" title="9"></a>
<a class="sourceLine" id="cb3-10" title="10">  <span class="co">// p (parameter vector) is [-0.04 1e04 3e07]</span></a>
<a class="sourceLine" id="cb3-11" title="11">  ydot[<span class="dv">0</span>] = p[<span class="dv">0</span>] * y[<span class="dv">0</span>] + p[<span class="dv">1</span>] * y[<span class="dv">1</span>] * y[<span class="dv">2</span>];</a>
<a class="sourceLine" id="cb3-12" title="12">  ydot[<span class="dv">1</span>] = -p[<span class="dv">0</span>]*y[<span class="dv">0</span>] - p[<span class="dv">1</span>]*y[<span class="dv">1</span>]*y[<span class="dv">2</span>] - p[<span class="dv">2</span>]*y[<span class="dv">1</span>]*y[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb3-13" title="13">  ydot[<span class="dv">2</span>] = p[<span class="dv">2</span>] * y[<span class="dv">1</span>] * y[<span class="dv">1</span>];</a>
<a class="sourceLine" id="cb3-14" title="14"></a>
<a class="sourceLine" id="cb3-15" title="15">  <span class="cf">return</span> ydot;</a>
<a class="sourceLine" id="cb3-16" title="16"></a>
<a class="sourceLine" id="cb3-17" title="17">}</a></code></pre></div>
<p>The above is a re-write of the <code>cvRoberts_dns.c</code> example in the documentation of <code>CVODE</code>. The original example can be found the document <a href="https://computation.llnl.gov/sites/default/files/public/cv_examples.pdf">here</a>.</p>
</div>
</div>
<div id="putting-everything-together" class="section level2">
<h2>Putting everything together</h2>
<p>The entire <code>R</code> file to create right hand side of ODE function (which calculates rates of change) is as follows (also found in <code>/inst/examples/cv_Roberts_dns.r</code>):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="co"># ODEs described by an R function</span></a>
<a class="sourceLine" id="cb4-2" title="2">ODE_R &lt;-<span class="st"> </span><span class="cf">function</span>(t, y, p){</a>
<a class="sourceLine" id="cb4-3" title="3"></a>
<a class="sourceLine" id="cb4-4" title="4">   <span class="co">## initialize the derivative vector</span></a>
<a class="sourceLine" id="cb4-5" title="5">   ydot &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="dt">length =</span> <span class="kw">length</span>(y))</a>
<a class="sourceLine" id="cb4-6" title="6">   </a>
<a class="sourceLine" id="cb4-7" title="7">   <span class="co">## p (parameter vector) is  [-0.04 1e04 3e07]</span></a>
<a class="sourceLine" id="cb4-8" title="8">   </a>
<a class="sourceLine" id="cb4-9" title="9">   ydot[<span class="dv">1</span>] =<span class="st"> </span>p[<span class="dv">1</span>]<span class="op">*</span>y[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>p[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb4-10" title="10">   ydot[<span class="dv">2</span>] =<span class="st"> </span><span class="op">-</span>p[<span class="dv">1</span>]<span class="op">*</span>y[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>p[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">3</span>] <span class="op">-</span><span class="st"> </span>p[<span class="dv">3</span>]<span class="op">*</span>y[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb4-11" title="11">   ydot[<span class="dv">3</span>] =<span class="st"> </span>p[<span class="dv">3</span>]<span class="op">*</span>y[<span class="dv">2</span>]<span class="op">*</span>y[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb4-12" title="12"></a>
<a class="sourceLine" id="cb4-13" title="13">   ydot      <span class="co">## return ydot</span></a>
<a class="sourceLine" id="cb4-14" title="14">}</a>
<a class="sourceLine" id="cb4-15" title="15"></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="co"># ODEs can also be described using Rcpp</span></a>
<a class="sourceLine" id="cb4-17" title="17">Rcpp<span class="op">::</span><span class="kw">sourceCpp</span>(<span class="dt">code =</span> <span class="st">&#39;</span></a>
<a class="sourceLine" id="cb4-18" title="18"></a>
<a class="sourceLine" id="cb4-19" title="19"><span class="st">#include &lt;Rcpp.h&gt;</span></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="st">using namespace Rcpp;</span></a>
<a class="sourceLine" id="cb4-21" title="21"></a>
<a class="sourceLine" id="cb4-22" title="22"><span class="st">// [[Rcpp::export]]</span></a>
<a class="sourceLine" id="cb4-23" title="23"><span class="st">NumericVector ODE_Rcpp (double t, NumericVector y){</span></a>
<a class="sourceLine" id="cb4-24" title="24"></a>
<a class="sourceLine" id="cb4-25" title="25"><span class="st">  // Initialize ydot filled with zeros</span></a>
<a class="sourceLine" id="cb4-26" title="26"><span class="st">  NumericVector ydot(y.length());</span></a>
<a class="sourceLine" id="cb4-27" title="27"></a>
<a class="sourceLine" id="cb4-28" title="28"><span class="st">  // p (parameter vector) is [-0.04 1e04 3e07]</span></a>
<a class="sourceLine" id="cb4-29" title="29"><span class="st">  ydot[0] = p[0] * y[0] + p[1] * y[1] * y[2];</span></a>
<a class="sourceLine" id="cb4-30" title="30"><span class="st">  ydot[1] = -p[0]*y[0] - p[1]*y[1]*y[2] - p[2]*y[1]*y[1]</span></a>
<a class="sourceLine" id="cb4-31" title="31"><span class="st">  ydot[2] = p[2] * y[1] * y[1];</span></a>
<a class="sourceLine" id="cb4-32" title="32"></a>
<a class="sourceLine" id="cb4-33" title="33"><span class="st">  return ydot;</span></a>
<a class="sourceLine" id="cb4-34" title="34"></a>
<a class="sourceLine" id="cb4-35" title="35"><span class="st">}&#39;</span>)</a>
<a class="sourceLine" id="cb4-36" title="36"></a>
<a class="sourceLine" id="cb4-37" title="37"><span class="co"># Generate time vector, IC and call cvode to solve the equations</span></a>
<a class="sourceLine" id="cb4-38" title="38"><span class="co"># R code to genrate time vector, IC and solve the equations</span></a>
<a class="sourceLine" id="cb4-39" title="39">time_vec &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.0</span>, <span class="fl">0.4</span>, <span class="fl">4.0</span>, <span class="fl">40.0</span>, <span class="fl">4E2</span>, <span class="fl">4E3</span>, <span class="fl">4E4</span>, <span class="fl">4E5</span>, <span class="fl">4E6</span>, <span class="fl">4E7</span>, <span class="fl">4E8</span>, <span class="fl">4E9</span>, <span class="fl">4E10</span>)</a>
<a class="sourceLine" id="cb4-40" title="40">IC &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb4-41" title="41">params &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.04</span>, <span class="dv">10000</span>, <span class="dv">30000000</span>)</a>
<a class="sourceLine" id="cb4-42" title="42">reltol &lt;-<span class="st"> </span><span class="fl">1e-04</span></a>
<a class="sourceLine" id="cb4-43" title="43">abstol &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">1e-8</span>,<span class="fl">1e-14</span>,<span class="fl">1e-6</span>)</a>
<a class="sourceLine" id="cb4-44" title="44"></a>
<a class="sourceLine" id="cb4-45" title="45"><span class="co">## Solving the ODEs using cvode function</span></a>
<a class="sourceLine" id="cb4-46" title="46">df1 &lt;-<span class="st"> </span><span class="kw">cvode</span>(time_vec, IC, ODE_R , params, reltol, abstol)           <span class="co">## using R</span></a>
<a class="sourceLine" id="cb4-47" title="47">df2 &lt;-<span class="st"> </span><span class="kw">cvode</span>(time_vec, IC, ODE_Rcpp , params, reltol, abstol)        <span class="co">## using Rcpp</span></a>
<a class="sourceLine" id="cb4-48" title="48"></a>
<a class="sourceLine" id="cb4-49" title="49"><span class="co">## Check that both solutions are identical</span></a>
<a class="sourceLine" id="cb4-50" title="50"><span class="co"># identical(df1, df2)</span></a></code></pre></div>
<p>The final output is the <code>df1</code> matrix in which first column is time, second, third and fourth column are the values of <code>y1</code>, <code>y2</code> and <code>y3</code> respectively.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="op">&gt;</span><span class="st"> </span>df1</a>
<a class="sourceLine" id="cb5-2" title="2">       [,<span class="dv">1</span>]         [,<span class="dv">2</span>]         [,<span class="dv">3</span>]       [,<span class="dv">4</span>]</a>
<a class="sourceLine" id="cb5-3" title="3"> [<span class="dv">1</span>,] <span class="fl">0e+00</span> <span class="fl">1.000000e+00</span> <span class="fl">0.000000e+00</span> <span class="fl">0.00000000</span></a>
<a class="sourceLine" id="cb5-4" title="4"> [<span class="dv">2</span>,] <span class="fl">4e-01</span> <span class="fl">9.851641e-01</span> <span class="fl">3.386242e-05</span> <span class="fl">0.01480205</span></a>
<a class="sourceLine" id="cb5-5" title="5"> [<span class="dv">3</span>,] <span class="fl">4e+00</span> <span class="fl">9.055097e-01</span> <span class="fl">2.240338e-05</span> <span class="fl">0.09446793</span></a>
<a class="sourceLine" id="cb5-6" title="6"> [<span class="dv">4</span>,] <span class="fl">4e+01</span> <span class="fl">7.158016e-01</span> <span class="fl">9.185043e-06</span> <span class="fl">0.28418924</span></a>
<a class="sourceLine" id="cb5-7" title="7"> [<span class="dv">5</span>,] <span class="fl">4e+02</span> <span class="fl">4.505209e-01</span> <span class="fl">3.222826e-06</span> <span class="fl">0.54947590</span></a>
<a class="sourceLine" id="cb5-8" title="8"> [<span class="dv">6</span>,] <span class="fl">4e+03</span> <span class="fl">1.832217e-01</span> <span class="fl">8.943516e-07</span> <span class="fl">0.81677741</span></a>
<a class="sourceLine" id="cb5-9" title="9"> [<span class="dv">7</span>,] <span class="fl">4e+04</span> <span class="fl">3.898091e-02</span> <span class="fl">1.621669e-07</span> <span class="fl">0.96101893</span></a>
<a class="sourceLine" id="cb5-10" title="10"> [<span class="dv">8</span>,] <span class="fl">4e+05</span> <span class="fl">4.936971e-03</span> <span class="fl">1.984450e-08</span> <span class="fl">0.99506301</span></a>
<a class="sourceLine" id="cb5-11" title="11"> [<span class="dv">9</span>,] <span class="fl">4e+06</span> <span class="fl">5.170103e-04</span> <span class="fl">2.069098e-09</span> <span class="fl">0.99948299</span></a>
<a class="sourceLine" id="cb5-12" title="12">[<span class="dv">10</span>,] <span class="fl">4e+07</span> <span class="fl">5.204927e-05</span> <span class="fl">2.082078e-10</span> <span class="fl">0.99994795</span></a>
<a class="sourceLine" id="cb5-13" title="13">[<span class="dv">11</span>,] <span class="fl">4e+08</span> <span class="fl">5.184946e-06</span> <span class="fl">2.073989e-11</span> <span class="fl">0.99999482</span></a>
<a class="sourceLine" id="cb5-14" title="14">[<span class="dv">12</span>,] <span class="fl">4e+09</span> <span class="fl">5.246212e-07</span> <span class="fl">2.098486e-12</span> <span class="fl">0.99999948</span></a>
<a class="sourceLine" id="cb5-15" title="15">[<span class="dv">13</span>,] <span class="fl">4e+10</span> <span class="fl">6.043000e-08</span> <span class="fl">2.417200e-13</span> <span class="fl">0.99999994</span></a></code></pre></div>
</div>
<div id="system-of-odes-for-parameter-sensitivities" class="section level2">
<h2>System of ODEs for Parameter Sensitivities</h2>
<p>Sensitivity with respect to the parameters of the ODE system can be calculated using <code>CVODES</code> function. This package implements Forward Sensitivity Analysis from <code>CVODES</code> function (see the example <code>cvRoberts_FSA_dns.c</code> from the link <a href="https://github.com/LLNL/sundials/blob/master/examples/cvodes/serial/cvsRoberts_FSA_dns.c">here</a>). Briefly, given the ODE system as described below</p>
<p><span class="math display">\[ 
\begin{aligned}
\frac{dy_1}{dt} &amp;= -p_1y_1 + p_2y_2y_3  \\ 
\frac{dy_2}{dt} &amp;= p_1y_1 - p_2y_2y_3 - p_3y_2^2 \\
\frac{dy_3}{dt} &amp;= p_3y_2^2 
\end{aligned}
\]</span> with the same initial conditions as above (i.e., <span class="math inline">\(y_1 = 0, y_2 = y_3 = 0\)</span>) and <span class="math inline">\(p_1 = 0.04, \quad p_2 = 10^4, \quad p_3 = 3\times10^7\)</span>. The system of Sensitivity equations (taken from <code>cvs_guide.pdf</code>) that is solved can be given by <span class="math display">\[
\begin{aligned}
\frac{ds}{dt} = 
\left[\begin{array}
{ccc}
-p_1 &amp; p_2y_3 &amp; p_2y_2 \\
p_1 &amp; -p_2y_3-2p_3y_2 &amp; -p_2y_2 \\
0 &amp; 2p_3y_2 &amp; 0
\end{array}\right]s_i + \frac{\partial f}{\partial p_i}, 
\quad s_i(t_0) = 
\left[\begin{array}  {c} 0 \\ 0 \\ 0 \end{array}\right], \quad i = 1, 2, 3 
\end{aligned}
\]</span> where <span class="math display">\[
\frac{\partial f}{\partial p_1} = \left[\begin{array}  {c} -y_1 \\ y_1 \\ 0 \end{array}\right],
\quad \frac{\partial f}{\partial p_2} = \left[\begin{array}  {c} y_2y_3 \\ -y_2y_3 \\ 0 \end{array}\right],
\quad
\frac{\partial f}{\partial p_3} = \left[\begin{array}  {c} 0 \\ -y_2^2 \\ y_2^2 \end{array}\right]
\]</span> In the original <code>CVODES</code> interface from <code>SUNDIALS</code>, the sensitivity equations can either be provided by the user or can be calculated using numerical interpolation by the solver. Here, I have only included the numerical interpolation version and currently the user cannot specify the sensitivity equations. However, in the future versions I will provide an ability to specify user-defined Jacobian as well as user-defined sensitivity equations.</p>
<p>Also, currently, forward sensitivities are calculated with respect to all parameters of the system. I plan to provide in future, an ability to specify specific particular parameters for which sensitivity is desired. Currently, <code>SIMULATENOUS</code> and <code>STAGGERED</code> methods of sensitivity calculations from the <code>SUNDIALS</code> library are supported in this package.</p>
</div>
<div id="calculation-of-sensitivities-using-cvodes" class="section level2">
<h2>Calculation of Sensitivities using <code>CVODES</code></h2>
<p>Once, the system of ODEs has been defined using the instructions provided above, sensitivities can be easily calculated using the <code>cvodes</code> function using the function call below:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">df1 &lt;-<span class="st"> </span><span class="kw">cvodes</span>(time_vec, IC, ODE_R , params, reltol, abstol,<span class="st">&quot;STG&quot;</span>,F)  <span class="co">## using R</span></a>
<a class="sourceLine" id="cb6-2" title="2">df2 &lt;-<span class="st"> </span><span class="kw">cvodes</span>(time_vec, IC, ODE_Rcpp , params, reltol, abstol,<span class="st">&quot;STG&quot;</span>,F)  <span class="co">## using R</span></a></code></pre></div>
<p>The additional arguments in <code>cvodes</code> specify the senstivity calculation method to be used (<code>STG</code> for <code>STAGGERED</code> or <code>SIM</code> for <code>SIMULATENOUS</code>) and flag for error control (either <code>T</code> or <code>F</code>).</p>
<p>The output of <code>cvodes</code> is a matrix with number of rows equal to the length of the time vector (<code>time_vec</code>) and the number of columns being equal to length of (<code>y</code> <span class="math inline">\(\times\)</span> <code>p</code> + 1). The first columns is for time. Currently, the sensitiviy of every enitity is calculated with respect to every parameter in model. For example, for the current model with <code>3</code> entities (ODEs) and <code>3</code> parameters, a total of <code>9</code> sensitivities are calculated at each output time, i.e. <code>y1</code> w.r.t <code>p1</code>, <code>p2</code>, <code>p3</code>, <code>y2</code> w.r.t. <code>p1</code>, <code>p2</code>, <code>p3</code> and so on. The first 3 (<code>length(y)</code>) columns give sensitivity w.r.t the first parameter, the next 3 (<code>length(y)</code>) columns give sensitivity w.r.t the second parameter and so on.</p>
<p>In the Sensitivity Matrix output for the systems of equations described above, the first column gives output time, the next <code>3</code> columns provide sensitivity of <code>y1</code>, <code>y2</code> and <code>y3</code> w.r.t first parameter (say <code>p1</code>), the next three columns provide sensitivity of <code>y1</code>, <code>y2</code> and <code>y3</code> w.r.t. the second parameter (<code>p2</code>) and so on. The output Sensitivity Matrix is given below. The sensitivity values match with the values provided in the <code>CVODES</code> documentation.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="op">&gt;</span><span class="st"> </span>df1</a>
<a class="sourceLine" id="cb7-2" title="2">       [,<span class="dv">1</span>]          [,<span class="dv">2</span>]          [,<span class="dv">3</span>]         [,<span class="dv">4</span>]         [,<span class="dv">5</span>]          [,<span class="dv">6</span>]          [,<span class="dv">7</span>]          [,<span class="dv">8</span>]          [,<span class="dv">9</span>]        [,<span class="dv">10</span>]</a>
<a class="sourceLine" id="cb7-3" title="3"> [<span class="dv">1</span>,] <span class="fl">0e+00</span>  <span class="fl">0.000000e+00</span>  <span class="fl">0.000000e+00</span> <span class="fl">0.000000e+00</span> <span class="fl">0.000000e+00</span>  <span class="fl">0.000000e+00</span>  <span class="fl">0.000000e+00</span>  <span class="fl">0.000000e+00</span>  <span class="fl">0.000000e+00</span> <span class="fl">0.000000e+00</span></a>
<a class="sourceLine" id="cb7-4" title="4"> [<span class="dv">2</span>,] <span class="fl">4e-01</span> <span class="fl">-3.561085e-01</span>  <span class="fl">3.902252e-04</span> <span class="fl">3.557183e-01</span> <span class="fl">9.483149e-08</span> <span class="fl">-2.132509e-10</span> <span class="fl">-9.461823e-08</span> <span class="fl">-1.573297e-11</span> <span class="fl">-5.289692e-13</span> <span class="fl">1.626194e-11</span></a>
<a class="sourceLine" id="cb7-5" title="5"> [<span class="dv">3</span>,] <span class="fl">4e+00</span> <span class="fl">-1.876130e+00</span>  <span class="fl">1.792229e-04</span> <span class="fl">1.875951e+00</span> <span class="fl">2.961233e-06</span> <span class="fl">-5.830758e-10</span> <span class="fl">-2.960650e-06</span> <span class="fl">-4.932970e-10</span> <span class="fl">-2.762408e-13</span> <span class="fl">4.935732e-10</span></a>
<a class="sourceLine" id="cb7-6" title="6"> [<span class="dv">4</span>,] <span class="fl">4e+01</span> <span class="fl">-4.247395e+00</span>  <span class="fl">4.592812e-05</span> <span class="fl">4.247349e+00</span> <span class="fl">1.372964e-05</span> <span class="fl">-2.357270e-10</span> <span class="fl">-1.372941e-05</span> <span class="fl">-2.288274e-09</span> <span class="fl">-1.138015e-13</span> <span class="fl">2.288387e-09</span></a>
<a class="sourceLine" id="cb7-7" title="7"> [<span class="dv">5</span>,] <span class="fl">4e+02</span> <span class="fl">-5.958192e+00</span>  <span class="fl">3.545986e-06</span> <span class="fl">5.958189e+00</span> <span class="fl">2.273754e-05</span> <span class="fl">-2.260807e-11</span> <span class="fl">-2.273752e-05</span> <span class="fl">-3.789554e-09</span> <span class="fl">-4.994795e-14</span> <span class="fl">3.789604e-09</span></a>
<a class="sourceLine" id="cb7-8" title="8"> [<span class="dv">6</span>,] <span class="fl">4e+03</span> <span class="fl">-4.750132e+00</span> <span class="fl">-5.991971e-06</span> <span class="fl">4.750138e+00</span> <span class="fl">1.880937e-05</span>  <span class="fl">2.312156e-11</span> <span class="fl">-1.880939e-05</span> <span class="fl">-3.134824e-09</span> <span class="fl">-1.875976e-14</span> <span class="fl">3.134843e-09</span></a>
<a class="sourceLine" id="cb7-9" title="9"> [<span class="dv">7</span>,] <span class="fl">4e+04</span> <span class="fl">-1.574902e+00</span> <span class="fl">-2.761679e-06</span> <span class="fl">1.574905e+00</span> <span class="fl">6.288404e-06</span>  <span class="fl">1.100645e-11</span> <span class="fl">-6.288415e-06</span> <span class="fl">-1.047876e-09</span> <span class="fl">-4.536508e-15</span> <span class="fl">1.047881e-09</span></a>
<a class="sourceLine" id="cb7-10" title="10"> [<span class="dv">8</span>,] <span class="fl">4e+05</span> <span class="fl">-2.363168e-01</span> <span class="fl">-4.584043e-07</span> <span class="fl">2.363173e-01</span> <span class="fl">9.450741e-07</span>  <span class="fl">1.832930e-12</span> <span class="fl">-9.450760e-07</span> <span class="fl">-1.574929e-10</span> <span class="fl">-6.362045e-16</span> <span class="fl">1.574935e-10</span></a>
<a class="sourceLine" id="cb7-11" title="11"> [<span class="dv">9</span>,] <span class="fl">4e+06</span> <span class="fl">-2.566355e-02</span> <span class="fl">-5.105587e-08</span> <span class="fl">2.566361e-02</span> <span class="fl">1.026491e-07</span>  <span class="fl">2.042044e-13</span> <span class="fl">-1.026493e-07</span> <span class="fl">-1.711080e-11</span> <span class="fl">-6.851356e-17</span> <span class="fl">1.711087e-11</span></a>
<a class="sourceLine" id="cb7-12" title="12">[<span class="dv">10</span>,] <span class="fl">4e+07</span> <span class="fl">-2.597859e-03</span> <span class="fl">-5.190342e-09</span> <span class="fl">2.597864e-03</span> <span class="fl">1.039134e-08</span>  <span class="fl">2.076100e-14</span> <span class="fl">-1.039136e-08</span> <span class="fl">-1.732552e-12</span> <span class="fl">-6.930923e-18</span> <span class="fl">1.732559e-12</span></a>
<a class="sourceLine" id="cb7-13" title="13">[<span class="dv">11</span>,] <span class="fl">4e+08</span> <span class="fl">-2.601996e-04</span> <span class="fl">-5.199259e-10</span> <span class="fl">2.602002e-04</span> <span class="fl">1.040802e-09</span>  <span class="fl">2.079717e-15</span> <span class="fl">-1.040804e-09</span> <span class="fl">-1.737821e-13</span> <span class="fl">-6.951356e-19</span> <span class="fl">1.737828e-13</span></a>
<a class="sourceLine" id="cb7-14" title="14">[<span class="dv">12</span>,] <span class="fl">4e+09</span> <span class="fl">-2.648142e-05</span> <span class="fl">-5.616896e-11</span> <span class="fl">2.648147e-05</span> <span class="fl">1.059193e-10</span>  <span class="fl">2.246502e-16</span> <span class="fl">-1.059195e-10</span> <span class="fl">-1.804535e-14</span> <span class="fl">-7.218146e-20</span> <span class="fl">1.804542e-14</span></a>
<a class="sourceLine" id="cb7-15" title="15">[<span class="dv">13</span>,] <span class="fl">4e+10</span> <span class="fl">-2.899376e-06</span> <span class="fl">-7.759920e-12</span> <span class="fl">2.899383e-06</span> <span class="fl">1.159764e-11</span>  <span class="fl">3.104024e-17</span> <span class="fl">-1.159768e-11</span> <span class="fl">-1.727574e-15</span> <span class="fl">-6.910296e-21</span> <span class="fl">1.727581e-15</span></a></code></pre></div>
<p>In future, I intend to provide options to select specific entities and parameters with respect to which sensitivities are to be computed as the sensitivity matrix can get very large for medium to large models.</p>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<p>The package <code>sundialr</code> provides a way to interface with the famous <code>SUNDIALS</code> C library to solver initial value problems. The package allows the system of differential equations to be written in <code>R</code> or using <code>Rcpp</code>. Currently only a single initialization of the ODE is supported, but we plan to add repeated initializations (e.g., repeated dosing) in near future for <code>CVODE</code>. For sensitivities, currently, calculation of forward sensitivities for all entities with respect to all the parameters in the model is implemented. However the ability to select specific entities and parameters for which sensitivities is to be calculated will be added soon. As a note, since this package is under active development, the interfaces of both <code>CVODE</code> and <code>CVODES</code> (i.e., the function signatures) may change in the future versions. Please keep this mind if you intend to use <code>sundialr</code> in your applications. In near future, interface for other solvers from the <code>C</code> library such as<code>IDA/IDAS</code> and <code>ARKODE</code> will also be added.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
